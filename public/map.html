<!DOCTYPE html>
<html>
<head>
  <title>Snap to Road - Google Maps API v3</title>
  <style type="text/css">
    html{height: 100%;}
    body {height: 100%; margin: 0; padding: 0; background-color: #000; font-size: small; font-family: Arial, "メイリオ", "Hiragino Kaku Gothic Pro", "ヒラギノ角ゴ Pro W4", "Osaka", "MS PGothic", sans-serif;}
    #header {position: absolute; top: 0px; left: 0; overflow: hidden; padding: 5px 5px; color: #FFF;}
    #map_canvas {position: absolute; top: 105px; left: 0; right: 205px; bottom: 0; width: auto; height: auto; overflow: hidden;}
    #route_canvas {position: absolute; top: 105px; right: 0; bottom: 0; width: 190px; height: auto; overflow: auto; padding: 5px 5px; background-color: #eaeaea; line-height: 1.8;}

  </style>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script type="text/javascript">
    var geocoder, map, path = [], service = new google.maps.DirectionsService(), shiftPressed = false, poly;
    var start_marker;
 
    var start_icon = "./img/start.png";
    google.maps.LatLng.prototype.kmTo = function(a){ 
        var e = Math, ra = e.PI/180; 
        var b = this.lat() * ra, c = a.lat() * ra, d = b - c; 
        var g = this.lng() * ra - a.lng() * ra; 
        var f = 2 * e.asin(e.sqrt(e.pow(e.sin(d/2), 2) + e.cos(b) * e.cos (c) * e.pow(e.sin(g/2), 2))); 
        return f * 6378.137; 
    } 

    google.maps.Polyline.prototype.inKm = function(n){ 
        var a = this.getPath(n), len = a.getLength(), dist = 0; 
        for(var i=0; i<len-1; i++){ 
          dist += a.getAt(i).kmTo(a.getAt(i+1)); 
        } 
        return Math.round(dist*1000) /1000 ; 
    } 

    function deletePolyline() {
      if (path.length > 0 ){
          if (path.length == 1 ){
              start_marker.setMap(null);
          }
          path.pop();
          poly.setPath(path);
          document.getElementById("route_canvas").innerHTML = poly.inKm() + "km";
      }
    }

    function deletePolylines() {
      if (path.length > 0 ){
          start_marker.setMap(null);
          path = [];
          poly.setPath(path);
          document.getElementById("route_canvas").innerHTML = poly.inKm() + "km";
      }
    }

    function search() {
      var address = document.getElementById("addressInput").value;
      geocoder.geocode({"address": address}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          map.setCenter(results[0].geometry.location);
        } else {alert("Geocode was not successful for the following reason: " + status);}
      });
    }

    function to_json(path) {
        var json = "{" +
        "\"distance\" : " + poly.inKm() + "," +
        "\"type\" : 1," + 
        "\"name\" : \"test\"," + 
        "\"path\" : \"LINESTRING(";
        for (var i = 0; i < path.length; i++) {
            if ( i > 0 ) {
                json = json + ",";
            }
            json = json + path[i].lat() + " " + path[i].lng();
        }
        json = json + ")\"}";
        return json;
    }

    function register() {

        if (path.length == 0 ){
            $("#route_canvas").html("ルートが設定されていません。");
        }
        else{

          $.ajax({
          url: '/route',
          type: 'POST',
          contentType: 'application/json',
          data: to_json(path),
          dataType: 'json'
          })
          .done(function( data ) {
              $("#route_canvas").html("登録が完了しました。");
          })
          .fail(function( data ) {
             $("#route_canvas").html("登録が失敗しました。");
          })
          .always(function( data ) {
              // ...
          });
        }
    }

    google.maps.event.addDomListener(document, "keydown", function() { shiftPressed = true; });
    google.maps.event.addDomListener(document, "keyup", function() { shiftPressed = false; });
		
    function Init() {
      var myOptions = {
        zoom: 17,
        center: new google.maps.LatLng(35.68923, 139.752274),
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        mapTypeControlOptions: {
          mapTypeIds: [google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.HYBRID, google.maps.MapTypeId.SATELLITE]
        },
        disableDoubleClickZoom: true,
        scrollwheel: false,
        draggableCursor: "crosshair"
      }

      document.getElementById("route_canvas").innerHTML = "0km";
      geocoder = new google.maps.Geocoder();
      map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
      google.maps.event.addListener(map, "click", function(evt) {
        if (shiftPressed || path.length == 0) {
            path.push(evt.latLng);
            var icoimg = new google.maps.MarkerImage(start_icon,
              new google.maps.Size(48, 48),
              new google.maps.Point(0, 0),
              new google.maps.Point(10, 10)
            );
            start_marker = new google.maps.Marker({position: evt.latLng, map: map, title: "start", icon: icoimg});
            if (path.length == 1) {
                poly = new google.maps.Polyline({ map: map , strokeColor: "#CC33FF"});
            }
            poly.setPath(path);
        } else {
            service.route({ origin: path[path.length - 1], destination: evt.latLng, travelMode: google.maps.DirectionsTravelMode.WALKING }, function(result, status) {
              if (status == google.maps.DirectionsStatus.OK) {
                path = path.concat(result.routes[0].overview_path);
                poly.setPath(path);
                document.getElementById("route_canvas").innerHTML = poly.inKm() + "km";
              }
            });
        }
      });
    }
  </script>
</head>
<body onload="Init()">
  <div id="header">
  <form action="#" onsubmit="register(); return false">
    <fieldset>
    <LEGEND>コース情報</LEGEND>
    <DIV class=control-group><LABEL class=control-label>コース名</LABEL> 
    <INPUT id=textinput class=input-xlarge type=text name=name placeholder="placeholder">
    <LABEL class=control-label>コースタイプ</LABEL> 
    <LABEL class=radio><INPUT value=片道 CHECKED type=radio name=radios> 片道 </LABEL><LABEL class=radio><INPUT value=周回 type=radio name=radios> 周回 </LABEL>
    <BUTTON id=singlebutton class="btn btn-primary" name=singlebutton type=submit>登録</BUTTON>
    </fieldset>
    <fieldset>
      <LEGEND>経路操作</LEGEND>
      ［住所・地名など］<input type="text" size="20" id="addressInput" value="新宿駅" />
      <input type="button" onclick="search()" value="移動" />
      <input type="button" onclick="deletePolyline()" value="戻す" />
      <input type="button" onclick="deletePolylines()" value="全クリア" />
    </fieldset>
    </form>
  </div>  
  <div id="map_canvas"></div>
  <div id="route_canvas"></div>
</body>
</html>
