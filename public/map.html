<!DOCTYPE html>
<html>
<head>
  <title>Snap to Road - Google Maps API v3</title>
  <style type="text/css">
    html{height: 100%;}
    body {height: 100%; margin: 0; padding: 0; background-color: #FFF; font-size: small; font-family: Arial, "メイリオ", "Hiragino Kaku Gothic Pro", "ヒラギノ角ゴ Pro W4", "Osaka", "MS PGothic", sans-serif;}
    #header {position: absolute; top: 0px; left: 0; overflow: hidden; padding: 5px 5px; color: #000;}
    #map_canvas {position: absolute; top: 120px; left: 0; right: 160px; bottom: 0; width: auto; height: auto; overflow: hidden;}
    #customBar {position: absolute; left: 70px; top: 120px;overflow: hidden;}
    #route_canvas {position: absolute; top: 120px; right: 0; bottom: 0; width: 160px; height: auto; overflow: auto; padding: 5px 5px; background-color: #eaeaea; line-height: 1.8;}

  </style>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link href="css/bootstrap-custom.css" rel="stylesheet" />
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script type="text/javascript">
    var geocoder, map, path = [], service = new google.maps.DirectionsService(), shiftPressed = false, poly;
    var start_marker;

    var MyPolyline = function(model) { 
        google.maps.Polyline.call(this,model);
   }

    MyPolyline.prototype = new google.maps.Polyline();
    MyPolyline.prototype.oldpath = undefined;
    MyPolyline.prototype.dist = undefined;

    MyPolyline.prototype.inKm = function() {
        if (this.getPath() != this.oldpath  ){
            var path = this.getPath(), len = path.getLength(), dist = 0;
            for(var i=0; i<len-1; i++){ 
              dist += path.getAt(i).kmTo(path.getAt(i+1)); 
            } 
            this.dist = Math.round(dist*1000) /1000 ; 
            this.oldpath = this.getPath();
        }
        return this.dist;
    }
    var start_icon = "./img/start-race.png";
    google.maps.LatLng.prototype.kmTo = function(a){ 
        var e = Math, ra = e.PI/180; 
        var b = this.lat() * ra, c = a.lat() * ra, d = b - c; 
        var g = this.lng() * ra - a.lng() * ra; 
        var f = 2 * e.asin(e.sqrt(e.pow(e.sin(d/2), 2) + e.cos(b) * e.cos (c) * e.pow(e.sin(g/2), 2))); 
        return f * 6378.137; 
    } 

    function deletePolyline() {
      if (path.length > 0 ){
          if (path.length == 1 ){
              start_marker.setMap(null);
          }
          path.pop();
          poly.setPath(path);
          document.getElementById("route_canvas").innerHTML = poly.inKm() + "km";
      }
    }

    function deletePolylines() {
      if (path.length > 0 ){
          start_marker.setMap(null);
          path = [];
          poly.setPath(path);
          document.getElementById("route_canvas").innerHTML = poly.inKm() + "km";
      }
    }

    function search() {
      var address = document.getElementById("addressInput").value;
      geocoder.geocode({"address": address}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          map.setCenter(results[0].geometry.location);
        } else {}
      });
    }

    function to_json(path) {
        var json = "{" +
        "\"distance\" : " + poly.inKm() + "," +
        "\"type\" : 1," + 
        "\"name\" : \"test\"," + 
        "\"path\" : \"LINESTRING(";
        for (var i = 0; i < path.length; i++) {
            if ( i > 0 ) {
                json = json + ",";
            }
            json = json + path[i].lat() + " " + path[i].lng();
        }
        json = json + ")\"}";
        return json;
    }

    function register() {

        if (path.length == 0 ){
            $("#route_canvas").html("ルートが設定されていません。");
        }
        else{

          $.ajax({
          url: '/route',
          type: 'POST',
          contentType: 'application/json',
          data: to_json(path),
          dataType: 'json'
          })
          .done(function( data ) {
              $("#route_canvas").html("登録が完了しました。");
          })
          .fail(function( data ) {
             $("#route_canvas").html("登録が失敗しました。");
          })
          .always(function( data ) {
              // ...
          });
        }
    }

    google.maps.event.addDomListener(document, "keydown", function() { shiftPressed = true; });
    google.maps.event.addDomListener(document, "keyup", function() { shiftPressed = false; });
		
    function Init() {
      var myOptions = {
        zoom: 17,
        center: new google.maps.LatLng(35.68923, 139.752274),
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        mapTypeControl: false,
        disableDoubleClickZoom: true,
        scrollwheel: false,
        draggableCursor: "crosshair"
      }

      document.getElementById("route_canvas").innerHTML = "0km";
      geocoder = new google.maps.Geocoder();
      map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
      google.maps.event.addListener(map, "click", function(evt) {
        if (shiftPressed || path.length == 0) {
            path.push(evt.latLng);
            var icoimg = new google.maps.MarkerImage(start_icon,
              new google.maps.Size(32, 37),
              new google.maps.Point(0, 0),
              new google.maps.Point(16, 37)
            );
            start_marker = new google.maps.Marker({position: evt.latLng, map: map, title: "start", icon: icoimg});
            if (path.length == 1) {
                poly = new MyPolyline({ map: map , strokeColor: "#CC33FF"});
            }
            poly.setPath(path);
        } else {
            service.route({ origin: path[path.length - 1], destination: evt.latLng, travelMode: google.maps.DirectionsTravelMode.WALKING }, function(result, status) {
              if (status == google.maps.DirectionsStatus.OK) {
                path = path.concat(result.routes[0].overview_path);
                poly.setPath(path);
                document.getElementById("route_canvas").innerHTML = poly.inKm() + "km";
              }
            });
        }
      });
    }
  </script>
</head>
<body onload="Init()">
  <div id="header">
    <form class="form-horizontal" onsubmit="register(); return false">
    <fieldset>
    <div class=control-group><label class=control-label for=textinput>コース名</label> 
    <div class=controls><input id=textinput class=input-xlarge type=text name=textinput placeholder="placeholder"> </div></div>
    <div class=control-group><label class=control-label for=radios>コース種別</label> 
    <div class=controls><label class="radio inline" for=radios-0><input id=radios-0 value=片道 checked type=radio name=radios> 片道 </label><label class="radio inline" for=radios-1><input id=radios-1 value=周回 type=radio name=radios> 周回 </label></div></div>
    <div class=control-group><!--label class=control-label for="">登録</label--> 
    <div class=controls><button class="btn btn-primary" name="" onclick="register()">登録</button> </div></div>
    </fieldset>
    </form>
  </div>
  <div id="map_canvas"></div>
  <div id="customBar">
    <form>
    <fieldset>
      <input type="address" id="addressInput" placeholder="地名を入力" />
      <input type="button" onclick="search()" value="移動" />
      <input type="button" onclick="deletePolyline()" value="戻す" />
      <input type="button" onclick="deletePolylines()" value="全クリア" />
    </fieldset>
    </form>
  </div>
  <div id="route_canvas"></div>
  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="js/bootstrap.min.js"></script>
</body>
</html>
